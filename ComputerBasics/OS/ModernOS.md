# 现代操作系统



# 概述

> **复习大纲：**
>
> 1. 操作系统的基本概念、基本功能；
>2. 分时系统、批处理系统、实时系统的主要特征；
> 3. 用户接口、系统调用过程
>4. 单道与多道程序技术；
> 5. 操作系统虚拟机体系结构
>6. CPU工作模式；



## 操作系统

> 操作系统的基本概念、基本功能

**功能：**

+ 资源管理者
  +  处理机管理 
  +  内存管理
  +  设备管理
  +  文件管理 
+ 扩展机器
  + 用户接口

<span style="color:blue;font-weight:bold">两个主要功能：</span>

+ 资源管理者——有效管理计算机软硬件资源
+ 作为扩展机器——为用户提供比实际机器更便于运用的抽象，包括进程、地址空间、文件等，提供接口

**主要功能：**处理机管理，内存管理，设备管理，文件管理，用户接口

**特征：**并发性，共享性，虚拟性，异步性

**两个基本特征**：并发性，共享性



## 系统分类

> 分时系统、批处理系统、实时系统 的主要特征

**批处理系统：**

+ 多道性、并发性、无序性、调度性

+ 无交互能力、作业平均周转周期长

**分时系统：**（N 个用户，时间片轮转，更强调人机交互）

+ 多路性、交互性、独占性、及时性

**实时系统**



## 单道与多道程序技术

> 单道与多道程序技术

**多道程序设计：**

+ <span style="color:blue">概念</span>：CPU在内存中多个进程之间迅速切换，使得多道程序能并发执行
+ 多道程序设计技术是**现代操作系统诞生的标志**

<span style="color:blue;font-weight:bold">分时系统和多道程序系统的区别：</span>

+ 分时系统运行多个用户使用自己的终端 同时 执行计算系统上的计算；多道程序系统允许用户同时运行多个程序
+ 所有分时系统都是多道程序设计系统；并非所有多道都是分时系统。因为多道可以在只一个用户的 PC 上运行



## 操作系统的硬件系统

### CPU

> CPU 工作模式

**CPU 两种工作模式：**用户态（仅允许执行部分指令和功能），内核态

+ 特权指令只能在内核态下执行
+ 因此用户程序必须通过 <span style="color:orange">系统调用</span> 陷入内核调用 OS 相关服务
+ <span style="color:blue">内核态和用户态的区别：</span> 内核态 CPU 可执行指令集中每条指令，可使用硬件所有功能；用户态只能部分



## 用户接口

> 用户接口、系统调用过程

**用户接口类型：**

+ 图形用户接口——图形化操作界面
+ 系统调用（程序接口）——用户程序用该接口访问系统资源，获取操作系统服务（库函数）
+ 命令接口（联机命令）——提供给用户以命令方式使用系统（Shell 语言）

**系统调用过程：**

1. Trap 指令，切换至内核态

<span style="color:blue;font-weight:bold">系统调用目的：</span> 请求系统服务



## 体系结构

> 操作系统虚拟机体系结构



# 进程与线程

> **复习大纲：**
>
> 1. 进程的基本概念、并发与并行；
>
> 2. 线程的基本概念
>
> 3. 进程与程序、进程与线程的区别与联系
>
> 4. 进程的实现（PCB）、线程的实现（TCB）；
>
> 5. 进程的状态及其转换；
>
> 6. 进程控制原语
>
> 7. 临界资源、临界区概念；
>
> 8. 进程通信的方式；
>
> 9. 进程的同步与互斥信号量实现；
>
> 10. 调度目标与常用的作业及进程调度算法；

**关系：**

一个进程可有多个线程

线程可并发执行

线程是调度的独立单位，资源分配给进程，同一进程所有线程共享该资源



## 进程

> 进程的基本概念、并发与并行

**进程：** **资源分配**的基本单位

**并发与并行：**

都是 CPU 执行多个任务的方式

并发：只有一个 CPU，在同一时间点，任务并不会同时运行，只是用**时间片轮转实现了宏观上**一个时间段内多个任务同时运行的效果

- 有竞争关系

并行：同一时刻多个任务同时执行。多个 CPU 实现

- 无竞争关系



## 线程

> 线程的基本概念

**概念：**进程的一个执行单元，是**独立调度**的基本单位



## 进程与程序, 进程与线程

> 进程与程序、进程与线程 的区别与联系

<span style="font-size:20px">进程与程序</span>

联系：一个程序生成多个进程

区别：程序不具备 动态，并发，独立，异步，结构



<span style="font-size:20px">进程与线程</span>

联系：线程依赖于进程，进程中使用多线程并行处理提高效率

区别：

- 系统开销：系统创建、撤销进程的开销远大于对线程的开销
- 通信：同一进程的线程间可直接读写；进程间通信需借助 IPC（进程间通信）



## 进程 / 线程 的实现

>  进程的实现（PCB 进程控制块）、线程的实现（TCB 线程控制块）

<span style="font-size:20px">进程的实体</span>

+ **进程的内存空间：**

  - 数据段——进程的全局变量和静态变量

  - 代码段

  - 堆栈段——栈存储函数调用信息；堆存储动态分配的内存

+ 进程表表项（进程控制块 **PCB**）

+ 正在执行的进程和 CPU 现场

<span style="font-size:20px">PCB 的实现</span>（Process Control Block）

**PCB 字段：**

+ 进程管理
+ 存储管理
+ 文件管理

**PCB 组织方式：**（组织多个 PCB）

+ 链接组织方式
+ 索引组织方式

<span style="font-size:20px">线程的实现：</span>

+ 用户空间中实现
+ 内核中实现
+ 混合实现



## 进程的状态及转换

![img](https://upload.wikimedia.org/wikipedia/commons/thumb/8/83/Process_states.svg/400px-Process_states.svg.png)

+ 就绪 **waiting**——等待调度；运行 **running**；阻塞 **blocked**——等待资源

  waiting——可运行，但因为其他进程正在运行而暂时停止

  runnning——占用 CPU

  blocked——除非某种外部事件发生，否则进程不能运行



## 进程控制原语

进程创建 `create()`

进程终止 `exit()`

进程阻塞 `block()`

进程唤醒 `wakeup()`



## 临界资源、临界区

> 临界资源、临界区概念

**临界资源：**一次只允许一个进程使用的 软硬件资源

**临界区：**在每个进程中，访问临界资源（共享内存）的那部 分代码（那段程序）



## 进程间通信

> 1. 进程通信的方式
>
> 2. 进程的同步与互斥信号量实现

<span style="font-size:20px">基本概念</span>

**制约关系：**

+ 进程互斥（间接相互制约）：进程竞争共享——另一必须等待
+ 进程同步（直接相互制约）：进程间合作——相互协调

**中断：**响应硬件设备请求的一种机制



<span style="font-size:20px">解决进程互斥:</span>

+ **屏蔽中断：**进程进入临界区后先关中 断，离开前开中断

+ **加锁法：**锁变量来表示临界区是否可用

+ **严格轮换法**
+ **Peterson 解决方案**
+ **TSL 指令**

 

### IPC

Inter Process Communication——进程通信

<span style="font-size:20px; color:red">信号量 - Semaphore</span>

值仅由 `down` / P, `up` / V **原语改变**

**物理意义：**s >= 0: 可使用资源数；s < = 等待使用资源的进程数

`P(S)` 申请一个资源；`V(S)` 释放一个资源

**复杂情况：** 一个同步 P 操作与一个互斥 P 操作在一起时,同步 P 在互斥 P 前



<span style="font-size:20px">管程 - Monitor</span>

**概念：**更高级的同步原语，进入管程的互斥由编译器负责，使用者只需将临界区转换为管程

**特性：**任一时刻管程中只能有一个活跃进程



<span style="font-size:20px">消息传递 - Message Passing：</span>

**实现：**两个原语 `send`, `receive`

...



## 调度

> 调度目标与常用的作业及进程调度算法

**调度目标：**

+ 低级调度 / 处理机调度（进程调度）
+ 中级调度 / 内存调度
+ 高级调度 / 作业调度



**性能评价指标：**

+ 平均周转时间 T: 每一任务完成 - 提交时间 之和 $\frac{1}{n} \sum{T_i}$

+ 平均带权周转时间 T' : $\frac{1}{n} \sum{T_i^1}$

+ 平均等待时间 W : $\frac{1}{n} \sum{W_i}$



<span style="font-size:20px;color:red">调度算法</span>

**先来先服务 FCFS**

**最短作业优先 SJF**

**轮转调度 RR：**时间片 q

**优先级调度**

**多级队列调度**



# 死锁

> **考试大纲：**
>
> 1. 死锁的概念
> 2. 死锁产生的原因及必要条件
> 3. 死锁问题的四个解决策略
> 4. 安全状态的定义、银行家算法



## 概念

> 死锁的概念

**死锁：**一个进程集合中的每个进程都在等待只能由该进程集合中的其他进程才能引发的事件

**不可抢占资源：**从拥有它的进程中抢占将引起相关计算的失败



## 产生原因 ，必要条件

> 死锁产生的原因及必要条件

**形成死锁**四个**必要条件：**

1. 互斥
2. 占有和等待
3. 不可抢占资源
4. 环路等待：存在一条环路，该环路中的每一个进程都在等待下一个进程所占有的资源



## 解决策略

> 死锁问题的四个解决策略

**鸵鸟算法：**（忽略死锁）

**解除死锁**

1. 死锁检测
2. 死锁恢复
   + 抢占
   + 回滚
   + 杀死进程

通过资源分配 **死锁避免：**动态分配资源时防止系统进入不安全状态

+ 银行家算法：进程预先告知自己的最大资源需求

破坏必要条件 **防止死锁** 产生



## 安全状态，银行家算法

> 安全状态的定义、银行家算法

**安全状态：**现有的资源占有情况下，按照某推进顺序仍可使每个进程得到其对资源的最大需求



<span style="color:red">**银行家算法**</span>

==。。。==



# 存储管理

> **考试大纲：**
>
> 1. 分页存储管理方式原理及地址映射过程
> 2. 虚拟存储技术（覆盖、交换）
>
> 3. 物理内存管理方式（位图、空闲链表）
>
> 4. 页表组成、TLB、页的大小
>
> 5. 常用页面置换算法及缺页率计算（FIFO，LRU，时钟页面置换算法）
>
> 6. 段式与页式存储管理方式的主要区别



## 分页存储管理方式, 地址映射

> 分页存储管理方式原理及地址映射过程



<span style="font-size:20px">地址映射</span>（重定位）

从逻辑地址到物理地址的地址映射



## 虚拟存储技术

> 虚拟存储技术（覆盖、交换）

**内存超载 解决方案：**

+ 交换——进程完整 调入内存，使该进程运行一段时间，然后把 它调回磁盘
+ 覆盖——程序按逻辑覆盖
+ 虚拟内存



<span style="font-size:20px">虚拟内存</span>

处理内存超载的重要技术

基本思想：每个进程拥有自己的地址空间，分割成多个大小相等的块，每一块称作页。让部分页进驻内存也能顺利执行

技术基础：离散内存分配。进程的<span style="color:orange">逻辑地址空间分散存储</span>在内存不连续的<span style="color:orange">物理地址空间</span>



## 物理内存管理方式

> 物理内存管理方式（位图、空闲链表）

<span style="font-size:20px">位图</span>

内存划分成一定大小的分配单元，每 个单元对应位图中的一位



<span style="font-size:20px">空闲链表</span>



## 页

> 页表组成、TLB、页的大小

<span style="font-size:20px">页表</span>

**页表**给出 虚拟地址 与 物理地址 之间 的映射关系

**MMU：**内存管理单元，完成地址映射。

+ CPU 发送 虚拟地址 给 MMU
+ MMU 发送 物理地址 给 存储器



<span style="font-size:20px">TLB</span>

用于**加速分页**，存储少量 页表项 的相关信息

**TLB：**Translation Lookaside buffer 转换检测缓冲区。通常在 MMU 中



## 页面置换算法

> 常用页面置换算法及缺页率计算（FIFO，LRU，时钟页面置换算法）

**场景：**

1. 访问页不在内存，引起**缺页中断**
2. 无空闲页框
3. **页面置换** 选择一个页面换出，为即将调入内存的页面腾出空间



<span style="font-size:20px">FIFO</span> ——先进先出页面置换算法

OS 维护一个 所有当前在内存中页面 的 <span style="color:orange">链表</span>

在 表头 的最久进入页 被置换出内存



<span style="font-size:20px">LRU</span> ——最近最少使用页面置换算法

<span style="color:orange">链表</span>



<span style="font-size:20px">Clock</span>——时钟页面置换算法

<span style="color:orange">环形链表</span>，表针指向最老页面

置换时检查表头页面的访问位 R



## 段式与页式 区别

> 段式与页式存储管理方式的主要区别

+ 页是信息的<span style="color:orange">物理单位</span>，段是信息的<span style="color:orange">**逻辑单位**</span>， 分页是系统管理的需要，分段是用户的需要

+ 页大小固定；段**大小动态变化**
+ 分段系统 **二维逻辑地址空间**；分页系统一维
+ 分段易实现 **共享和动态链接**



# 文件系统

> **考试大纲：**
>
> 1. 文件的逻辑结构、物理结构
>
> 2. 文件FCB、文件目录及实现、目录文件
>
> 3. 文件的共享方式
>
> 4. 文件系统的可靠性
>
> 5. 文件系统的性能
>
> 6. ==?== 的磁盘空间管理成组链接法

## 文件结构

> 文件的逻辑结构、物理结构

<span style="font-size:20px">逻辑结构</span>

+ 字节序列
+ 记录序列（顺序结构）
+ 树



## 目录

> 文件 FCB、文件目录及实现、目录文件

<span style="font-size:20px">FCB</span>

FCB（**文件控制块**）——目录项，目录的基本组成元素

**内容：**管理文件所需有关信息——文件名，存储地址，存取控制信息，使用信息 等



<span style="font-size:20px">目录</span>

FCB 的有序集合

**实现：**访问文件时，

1. OS 利用用户提供的<span style="color:orange">路径名</span>找到该文件的 <span style="color:orange">FCB</span>
2. 根据<span style="color:orange">FCB</span> 的信息<span style="color:orange">访问文件</span>



<span style="font-size:20px">目录文件</span>

**目的：**为了实现对文件目录的管理

**概念：** 将文件目录<span style="color:orange">以文件的形式保存在外存</span>，这个文件就叫目录文件



## 共享文件

> 文件的共享方式

通过 <span style="font-size:20px">符号链接</span> 共享文件

**本质** 通过 LINK 类型文件路径名指向共享文件

**特点** 额外 存储和查找 开销大




## 文件系统可靠性
> 文件系统的可靠性

**保障可靠性措施:**

1. 文件系统备份
2. 文件系统一致性检查



<span style="font-size:20px">文件系统备份</span>

自动进行（转储程序和恢复程序）

**转储策略：** 全量 / 增量

**转储方案：**物理转储 / 逻辑转储

+ 物理：全部磁盘盘块按序输出到备份磁带（全量）
+ 逻辑：递归转储基准日期后更改的文件（增量）

**逻辑转储 算法过程：**

> <img src="https://camo.githubusercontent.com/b5b4ece6b83333d0b3d5baa50d134e67efa44212bc4dcfb9451a2158721e3ea0/68747470733a2f2f696d67323032302e636e626c6f67732e636f6d2f626c6f672f313531353131312f3230323030332f313531353131312d32303230303332353133313531323933312d323035313039363031302e706e67" alt="img" style="zoom:33%;" />
>
> <img src="https://camo.githubusercontent.com/05673a38404314866fda86c5fde86717f6881ec65476b76a3209df63d15f0887/68747470733a2f2f696d67323032302e636e626c6f67732e636f6d2f626c6f672f313531353131312f3230323030332f313531353131312d32303230303332353133313532313033372d3938363232383237372e706e67" alt="img" style="zoom:33%;" />

0. 维持一个以节点号为索引的**位图**
1. 递归检查所有目录项，<span style="color:orange">标记修改过的节点（文件和目录）</span>
2. 删除目录树中 不含修改过文件/目录 的目录 的标记
3. 转储位图中所有已标记目录
4. 储位图中所有已标记文件

**文件系统恢复：**

1. 在磁盘创建一空文件系统
2. 恢复最近完整转储
3. 恢复增量存储



<span style="font-size:20px">文件系统一致性</span>

**问题：**盘块修改后由于系统崩溃没有全部写回会导致不一致

**盘块的一致性检查：**

1. 构造两张为每个盘块设立一个计数器的表。一张记录盘块在文件中出现次数，另一记录在空闲表出现次数

+ 一致的状态（每个块号在两张表只出现一次 1 - 0 / 0 - 1）：

<img src="https://camo.githubusercontent.com/e38622a299193ef6d7939df5dd3a8586a1591d695c9aad1b7f628ec44c69beb4/68747470733a2f2f696d67323032302e636e626c6f67732e636f6d2f626c6f672f313531353131312f3230323030332f313531353131312d32303230303332353133313630373031332d3835363637353937382e706e67" alt="img" style="zoom: 33%;" />

+ 某块号丢失 （0 - 0）：添加到空闲表
+ 在空闲表重复（0 - 2）：
  + 解决：修改空闲表
  + 注意：位图法记录空闲盘块，则不会出现该状态
+ 在两文件重复（2 - 0）：
  1. 分配一空闲块
  2. 复制 i 号块内容到空闲块
  3. 用 i 号块替换某文件中 i 号块
  4. 报告用户检查文件内容

**文件一致性**：

构造一张表，计数器，记录文件在目录系统出现次数

注意：

+ 硬连接引起的文件共享使得文件 可能出现在多个目录中
+ 但 符号链接的共享 不会计数



## 文件系统性能

> 文件系统的性能

访问磁盘速度远远慢于访问内存

 **改善性能的常见三种措施：**高速缓存、块提前读、减少磁臂运动



<span style="font-size:21px">高速缓存</span>

**本质：**逻辑上磁盘，物理上在内存

**注意：**区分于虚拟内存

**思想：**把磁盘上若干块保存在高速缓存，访问时先在高速缓存查找再访问物理磁盘

**技术点：**

+ 页面置换算法——实现高速缓存中盘块的置换
+ 高速缓存中快速查找块——根据盘块地址建立散列表



<span style="font-size:21px">块提前读</span>

在需要使用块之前写入高速缓存（提高命中率）

**特点：**只适用于顺序读取



<span style="font-size:21px">减少磁臂运动</span>

**思想：**把有可能顺序访问的块放在一起，最好是在同一柱面上从而减少磁盘臂的移动次数



# 设备管理

> **复习提纲：**
>
> 1. 常用 I/O 数据传送方式
> 2. I/O 独立编址与统一编址
> 3. Spooling 系统
> 4. I/O 软件的分层结构及其功能
> 5. 磁盘设备读写时间构成
> 6. 常用磁盘臂调度算法

## I/O 传输方式

> 常用 I/O 数据传送方式

**四大方式：** 

+ 程序控制 I/O 方式、中断驱动 I/O 方式、DMA 控制 I/O 方式、通道控制 I/O 方式
+ CPU 与 I/O 设备<span style="color:orange">并行度</span>递增；<span style="color:orange">单次控制传输量</span>递增；<span style="color:orange">设备速度</span>递增

<span style="font-size:21px">程序控制 I/O</span>

**过程：**

1. CPU 向 控制器 发指令，启动 I/O 设备
2. 同时，状态寄存器中状态标志 置 1（busy = 1）
3. 循环检测 busy 标志

**缺点：**字节为数据交换单位，CPU 忙等待 I/O



<span style="font-size:21px">中断驱动 I/O</span>

**过程：**

1. CPU 发出 I/O 命令
2. CPU 执行其它进程，与外设 <span style="color:orange">并行工作</span>
3. I/O 完成操作，控制器向 CPU 发送中断信号，CPU 应答中断
4. 原进程继续运行

**缺点：**字节为数据交换单位。设备较多时，中断次数会很多，CPU 计算时间减少



<span style="font-size:21px">DMA 控制 I/O 方式</span>

**DMA——直接内存访问：**意味着 CPU 授予 I/O 模块权限在不涉及 CPU 的情况下读取或写入内存，减少 CPU 对 I/O 操作干预

**DMA 控制器组成：**

+ 控制 / 状态 寄存器 CR
+ 内存地址寄存器 MAR
+ 数据寄存器 DR
+ 数据计数器 DC



<span style="font-size:21px">通道控制 I/O 方式</span>

**引入：** 

1. 进一步减少 CPU 的干预
2. 多个块为单位传送
3. 一次传送多组数据到多个内存区域



## IO 端口编址方式

> I/O 独立编址与统一编址

外设通过读写设备上的寄存器来进行，外设寄存器也称为 **I/O 端口**

<span style="font-size:21px">统一编址</span>

主存的一部分划出来用作 IO 地址空间，每个端口占用一个存储单元的地址



<span style="font-size:21px">独立编址</span>

IO 地址与存储地址分开独立编址，I/O 端口地址不占用存储空间的地址范围

通过 MEMR/MEMW 和 IOR/IOW 两组控制信号来实现对 I/O 端口和存储器的<span style="color:orange">不同寻址</span>



## I/O 软件层次

> I/O 软件的分层结构及其功能

各层结构和功能：

<img src="https://camo.githubusercontent.com/49f85a56fa6993e60d5b2569e4c9ba6bad4c973c9db31ebef7fd6518df1f8f49/68747470733a2f2f696d67323032302e636e626c6f67732e636f6d2f626c6f672f313531353131312f3230323030362f313531353131312d32303230303631383130353734363432302d313330313038363131332e706e67" alt="img" style="zoom:33%;" />



### SPOOLing 系统

> Spooling 系统

**层次：** 用户空间的 I/O 软件

**假<span style="color: orange">脱机</span>系统** SPOOLing, Simultaneous Peripheral Operation On Line

**意义：**专门利用 SPOOLing 程序完成对设备的 IO 操作，无需使用外围 I/O 处理机（真脱机系统）



## 盘

> 1. 磁盘设备读写时间构成
> 2. 常用磁盘臂调度算法

<span style="font-size:20px">RAID</span>

**廉价磁盘冗余阵列**，简称 磁盘阵列

利用虚拟化技术把多个硬盘结合在一起，成为一个或多个磁盘阵列组



### 磁盘设备读写时间构成

+ **寻道时间：**占主导地位，由磁臂移动速度和磁臂调度算法决定 
+ **旋转延迟时间：**由转速和盘块位置决定 
+ **数据传输时间：**由转速和数据传输量决定



### 磁臂调度算法

磁盘驱动程序响应进程的磁盘请求

<span style="font-size:20px">FCFS</span> 先来先服务



<span style="font-size:20px">SSF</span> 最短寻道优先

选择从当前磁头位置出发，移动最少的磁盘 IO 请求

可能有饥饿状态



<span style="font-size:20px">SCAN</span> 电梯算法

选择当前磁头前进方向上移动最少请求，没有时才改变方向

消除饥饿现象



<span style="font-size:20px">C-SCAN</span> 循环扫描

按固定方向扫描，到达边沿请求直接移动到另一沿第一个请求柱面



# 安全与虚拟化技术

> **复习大纲：**
>
> 1. 系统保护机制：访问控制矩阵、ACL、权能表
> 2. 第一类与第二类虚拟机管理程序
